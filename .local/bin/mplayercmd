#!/bin/sh

usage() {
    echo "Usage: `basename $0` <start|pause|next|prev>"
    echo "  or   `basename $0` <play|add> PATH"
    exit 1
}

fifo=$HOME/.mplayer/fifo
playlist=$HOME/.mplayer/playlist

if [ $# -eq 2 ]; then
    append="0"
    [ "$1" = "add" ] && append="1"
    [ "$1" = "play" ] && append=""
    if [ "$append" = "0" ]; then usage
    elif [ -d "$2" ]; then
        find -L "$2" -iname '*.flac' -o -iname '*.mp3' -o -iname '*.ogg' -o -iname '*.wav' | shuf > "$playlist"
        echo "loadlist $playlist $append" > "$fifo"
    elif [ -f "$2" ]; then
        echo "loadfile \"$2\" $append" > "$fifo"
    else usage
    fi
elif [ $# -eq 1 ]; then
    if [ "$1" = "start" ]; then
        [ -e "$fifo" ] && rm "$fifo"
        mkfifo "$fifo"
        mplayer -slave -quiet -idle -input file="$fifo" 2> /dev/null | \
        grep --line-buffered -o "Playing .*" | \
        gawk -v fc=$(tput sgr0) -v f4=$(tput setaf 4) -v f6=$(tput setaf 6) \
            'match($0, /Playing (.*\/(.*)\/)(.*)\..*\./, arr) {
                parentDirFull=arr[1]
                parentDir=arr[2]
                fileName=arr[3]
                print f4 parentDir " " f6 fileName fc
                system("cat \"" parentDirFull "/lyrics/" fileName ".txt" "\" 2>/dev/null")
            }'
    elif [ "$1" = "pause" ]; then echo "pause" > "$fifo"
    elif [ "$1" = "next" ]; then echo "pt_step 1" > "$fifo"
    elif [ "$1" = "prev" ]; then echo "pt_step -1" > "$fifo"
    else usage
    fi
else usage
fi
