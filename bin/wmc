#!/bin/sh

pfw=$(pfw)
xp=$(wattr x $pfw)
wp=$(wattr w $pfw)
hp=$(wattr h $pfw)
if [ $# -eq 1 ]; then
    if [ "$1" = "loop" ]; then
        while IFS=: read ev wid; do
            case $ev in
                18) wattr $(pfw) || wmc focus $(lsw | sed '$ p;d') ;;
                4|7|19) wattr o $wid || wmc focus $wid ;;
            esac
        done
    elif [ "$1" = "resize" ]; then
        r=$(xrandr | grep "*" | cut -d' ' -f4)
        r1=$(echo $r | sed "1q;d")
        r2=$(echo $r | sed "2q;d")
        sw1=${r1%x*}
        sw2=${r2%x*}
        sh1=${r1#*x}
        sh2=${r2#*x}
        [ $xp -ge $sw1 ] && dn=2 dx=$w1 sw=$sw2 sh=$sh2 || dn=1 dx=0 sw=$sw1 sh=$sh1
        [ $wp -eq $sw ] && ww=$((sw / 2)) || ww=$sw
        wtp $dx 0 $ww $sh $pfw
        wmp -a $((ww / 2 + xp)) $((hp / 2))
    elif [ "$1" = "switch" ]; then
        [ $xp -eq 0 ] && wmv 9999 0 $pfw || wmv -9999 0 $pfw
        wmc focus $pfw
    fi
elif [ $# -eq 2 ]; then
    if [ "$1" = "focus" ]; then
        wid=$2
        x=$(wattr x $wid)
        y=$(wattr y $wid)
        w=$(wattr w $wid)
        h=$(wattr h $wid)
        chwso -r $wid
        wtf $wid
        mapw -m $wid
        wmp -a $((w / 2 + x)) $((h / 2 + y))
    fi
elif [ $# -eq 3 ]; then
    if [ "$1" = "group" ]; then
        terminal=st-256color
        browser=vimb
        dnum=$2
        group=$3
        if [ "$group" != "a" ]; then
            for wid in $(lsw); do
                class=$(xprop -id $wid WM_CLASS | cut -d\" -f2)
                type=o
                [ "$class" = "$terminal" ] && type=t
                [ "$class" = "$browser" ] && type=b
                xprop -id $wid -f WMG 8s -set WMG $type
            done
        fi
        uwids=""
        mwids=""
        for wid in $(lsw -a); do
            g=$(xprop -id $wid WMG | grep 'WMG(STRING) =' | cut -d\" -f2)
            x=$(wattr x $wid)
            [ $x -eq 0 ] && dn=0 || dn=1
            if [ $dn -eq $dnum ]; then
                uwids="$uwids $wid"
                [ "$g" = "$group" ] && mwids="$wid"
                [ "a" = "$group" ] && mwids="$mwids $wid"
            fi
        done
        mapw -u $uwids
        mapw -m $mwids
    fi
else
    name=$(basename $0)
    echo "usage: $name loop"
    echo "       $name resize"
    echo "       $name switch"
    echo "       $name focus <wid>"
    echo "       $name group <NUM> <t|b|o>"
fi
