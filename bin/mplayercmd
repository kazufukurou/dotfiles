#!/bin/sh

usage() {
  echo "Usage: `basename $0` <start|pause|next|prev>"
  echo "  or:  `basename $0` play PATH"
  echo "  or:  `basename $0` add PATH"
  exit 1
}

fifo=$HOME/.mplayer/fifo
playlist=$HOME/.mplayer/playlist
f7=$(tput setaf 7)
f5=$(tput setaf 5)
f4=$(tput setaf 4)
f1=$(tput setaf 1)
f0=$(tput setaf 0)
c=$(tput sgr0)
append=""

if [ $# -eq 2 ]; then
    [ "$1" = "add" ] && append="1"
    if [ -d "$2" ]; then
        find "$2" -iname '*.flac' -o -iname '*.mp3' -o -iname '*.ogg' | shuf > "$playlist"
        echo "loadlist $playlist $append" > "$fifo"
    elif [ -f "$2" ]; then
        echo "loadfile \"$2\" $append" > "$fifo"
    else usage
    fi
elif [ $# -eq 1 ]; then
    if [ "$1" = "start" ]; then
        [ -e "$fifo" ] && rm "$fifo"
        mkfifo "$fifo"
        mplayer -slave -quiet -idle -input file="$fifo" 2> /dev/null | grep --line-buffered -o "Playing .*" | sed "s%Playing /.*/\([^/]*\)/\([^ ]*\) \([^/]*\)/[^ ]\{2\} \([^/]*\)\..*\.%$f4\1 $f0\2 $f5\3 $f7\4$c%"
    elif [ "$1" = "pause" ]; then echo "pause" > "$fifo"
    elif [ "$1" = "next" ]; then echo "pt_step 1" > "$fifo"
    elif [ "$1" = "prev" ]; then echo "pt_step -1" > "$fifo"
    else usage
    fi
else
    usage
fi
