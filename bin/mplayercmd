#!/bin/sh

usage() {
    echo "Usage: `basename $0` <start|pause|next|prev>"
    echo "  or   `basename $0` <play|add> PATH"
    exit 1
}

fifo=$HOME/.mplayer/fifo
playlist=$HOME/.mplayer/playlist

if [ $# -eq 2 ]; then
    append=""
    [ "$1" = "add" ] && append="1"
    if [ -d "$2" ]; then
        find "$2" -iname '*.flac' -o -iname '*.mp3' -o -iname '*.ogg' | shuf > "$playlist"
        echo "loadlist $playlist $append" > "$fifo"
    elif [ -f "$2" ]; then
        echo "loadfile \"$2\" $append" > "$fifo"
    else usage
    fi
elif [ $# -eq 1 ]; then
    if [ "$1" = "start" ]; then
        [ -e "$fifo" ] && rm "$fifo"
        mkfifo "$fifo"
        mplayer -slave -quiet -idle -input file="$fifo" 2> /dev/null | \
        grep --line-buffered -o "Playing .*" | \
        gawk -v fc=$(tput sgr0) \
            -v f1=$(tput setaf 1) \
            -v f4=$(tput setaf 4) \
            -v f5=$(tput setaf 5) \
            -v f6=$(tput setaf 6) \
            -v f7=$(tput setaf 7) \
            'match($0, /Playing ((.*\/(.*)\/)([0-9\-]* )?(.*)\/([0-9.]* )?(.*)\..*)\./, arr) {
                if (arr[3] == "_other") {
                    print f6 arr[5] " " f1 arr[7] fc
                    system("cat \"" arr[2] "/" arr[5] "/lyrics/" arr[7] ".txt" "\" 2>/dev/null")
                } else {
                    print f6 arr[3] " " f4 arr[4] f5 arr[5] " " f1 arr[7] fc
                    system("cat \"" arr[2] "lyrics/" arr[7] ".txt" "\" 2>/dev/null")
                }
            }'
    elif [ "$1" = "pause" ]; then echo "pause" > "$fifo"
    elif [ "$1" = "next" ]; then echo "pt_step 1" > "$fifo"
    elif [ "$1" = "prev" ]; then echo "pt_step -1" > "$fifo"
    else usage
    fi
else usage
fi
