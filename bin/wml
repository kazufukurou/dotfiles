#!/bin/sh

. ~/.config/wmrc/config

usage() {
    echo "usage: $(basename $0) <full|tile|grid>"
    exit
}

WN=0
for wid in $(lsw); do
    if samedisplay $wid; then
        WN=$((WN+1))
    fi
done

fscheck() {
    if [ $WN -eq 1 ]; then
        full
        exit
    fi
}

full() {
    for wid in $(lsw); do
        if samedisplay $wid; then
            wtp $DX $PANEL $((SW - 2 * WB)) $((SH - 2 * WB - PANEL)) $wid
        fi
    done
}

tile() {
    fscheck
    MAX=$((WN - 1))
    X=$((DX))
    Y=$((PANEL))
    W=$((SW / 2 - 2 * WB))
    wtp $X $Y $W $((SH - 2 * WB - PANEL)) $PFW
    X=$((W + 2 * WB + DX))
    H=$(((SH - PANEL) / MAX - 2 * WB))
    for wid in $(lsw | grep -v $PFW); do
        if samedisplay $wid; then
            wtp $X $Y $W $H $wid
            Y=$((Y + H + 2 * WB))
        fi
    done
}

grid() {
    fscheck
    SQRT=$(echo "sqrt($WN)" | bc)
    [ $((SQRT * SQRT)) -lt $WN ] && COLS=$((SQRT + 1)) || COLS=$SQRT
    [ $((COLS * COLS - WN)) -lt $COLS ] && ROWS=$COLS || ROWS=$((COLS - 1))
    X=$((DX))
    Y=$((PANEL))
    W=$((SW / COLS - 2 * WB))
    H=$(((SH - PANEL) / ROWS - 2 * WB))
    wtp $X $Y $W $H $PFW
    R=0
    C=1
    for wid in $(lsw | grep -v $PFW); do
        if samedisplay $wid; then
            X=$(((W + 2 * WB) * C + DX))
            Y=$(((H + 2 * WB) * R + PANEL))
            wtp $X $Y $W $H $wid
            [ $C -ge $((COLS - 1)) ] && C=0 || C=$((C + 1))
            [ $C -eq 0 ] && R=$((R + 1))
        fi
    done
}

case $1 in
    full) full ;;
    tile) tile ;;
    grid) grid ;;
    *) usage ;;
esac
