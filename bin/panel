#! /bin/bash

if [ $(pgrep -cx panel) -gt 1 ] ; then
    printf "%s\n" "The panel is already running." >&2
    exit 1
fi

trap 'trap - TERM; kill 0' INT TERM QUIT EXIT

workspaces=('▀ ' '▀▀' ' ▀' '█ ' '██' ' █' '▄ ' '▄▄' ' ▄' '▄▀')
f7=$(tput setaf 7)
f5=$(tput setaf 5)
f4=$(tput setaf 4)
f1=$(tput setaf 1)
f0=$(tput setaf 0)
blink=$(tput blink)
cv=$(tput civis)
c=$(tput sgr0)
mtitle=""
malbum=""
martist=""

cpu() {
    cpus=$(grep -c processor /proc/cpuinfo)
    echo $(ps -eo pcpu | awk -v "cpus=$cpus" '/\s*[1-9]/ NR==1 {sum=0} {sum+=$1} END {printf "%d\n", sum/cpus}')
}

temp() {
    echo $((`cat /sys/class/thermal/thermal_zone0/temp`/1000))
}

temp_color() {
    [ $1 -gt 80 ] && echo $f1 || [ $1 -gt 60 ] && echo $f5 || echo $f4
}

volume() {
    [ -n "$(amixer get Master | grep off)" ] && echo Mute || echo $(amixer get Master | tail -1 | cut -d ' ' -f6 | tr -d '[%]')
}

volume_color() {
    [ "Mute" = $1 ] && echo $f1 || echo $f7
}

battery() {
    battery=$(cat /sys/class/power_supply/BAT0/capacity)
    [ -z $battery ] && echo 0 || echo $battery
}

battery_status() {
    echo $(cat /sys/class/power_supply/BAT0/status)
}

battery_color() {
    [ $1 -le 10 ] && [ "$2" = "Discharging" ] && echo $f1$blink && return 0
    [ $1 -le 10 ] && echo $f1 && return 0
    [ $1 -le 50 ] && echo $f5 && return 0
    [ $1 -le 90 ] && echo $f4 && return 0
    echo $f7
}

system_loop() {
    while true; do
        t=$(temp)
        v=$(volume)
        b=$(battery)
        bs=$(battery_status)
        dm=$(date +%b)
        dd=$(date +%e)
        ddt=${dd## }
        dw=$(date +%a)
        dt=$(date +%R)
        tc=$(temp_color $t)
        vc=$(volume_color $v)
        bc=$(battery_color $b $bs)
        echo "S$f0$dm $f7$ddt $f0$dw $f7$dt$f0 T $tc$t$f0 V $vc$v$f0 B $bc$b"
        sleep 1
    done
}

panel_bar() {
    while read -r line ; do
        case $line in
            S*)
                sys="${line#?}"
                ;;
        esac
        wm_name=0
        wm_icon=${workspaces[$wm_name]}
        pfw=$(pfw)
        title=""
        [ -n "$pfw" ] && title=$(xprop -id $pfw WM_NAME | cut -d \" -f2)
        title=${title:0:160}
        echo $cv$f7$wm_icon$c $sys $mtitle $f0$title
    done
}

panel_fifo=/tmp/panel-fifo
[ -e "$panel_fifo" ] && rm "$panel_fifo"
mkfifo "$panel_fifo"
pfw=$(pfw)
chwb -s 0 $pfw
wmv -a 0 0 $pfw
ignw -s $pfw

system_loop > $panel_fifo &
cat "$panel_fifo" | panel_bar &
wait
